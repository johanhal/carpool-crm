#!/bin/bash
# Ruter - bedrifts칮k for samkj칮ring
# Finn bedrifter i et geografisk omr친de og kontaktpersoner for samkj칮ringspilot

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/venv/bin/activate"

echo "============================================================"
echo "  Ruter - bedrifts칮k for samkj칮ring"
echo "  Lag GeoJSON p친: https://geojson.io"
echo "============================================================"
echo ""

# Steg 1: Filtrer etter GeoJSON
# Capture output - last line is the output file path
OUTPUT=$(python "$SCRIPT_DIR/filter_companies.py" "$@")
EXIT_CODE=$?

# Print the output (except last two lines which are area_name and path)
echo "$OUTPUT" | head -n -2

if [ $EXIT_CODE -eq 0 ]; then
    # Get the area name and filtered file path (last two lines of output)
    AREA_NAME=$(echo "$OUTPUT" | tail -n 2 | head -n 1)
    FILTERED_FILE=$(echo "$OUTPUT" | tail -n 1)

    if [ -f "$FILTERED_FILE" ]; then
        # All files go in the area folder
        AREA_FOLDER=$(dirname "$FILTERED_FILE")

        # Intermediate files (will be deleted)
        ENRICHED_FILE="$AREA_FOLDER/.enriched_temp.csv"
        CONTACTS_FILE="$AREA_FOLDER/.contacts_temp.csv"

        # Final output files
        FINAL_CSV="$AREA_FOLDER/bedrifter.csv"
        FINAL_HTML="$AREA_FOLDER/rapport.html"

        echo ""
        echo "============================================================"
        echo "  Steg 2: Beriker med BRREG-data..."
        echo "============================================================"
        python "$SCRIPT_DIR/enrich_companies.py" "$FILTERED_FILE" -o "$ENRICHED_FILE"

        echo ""
        echo "============================================================"
        echo "  Steg 3: Finner kontaktpersoner med Claude..."
        echo "============================================================"
        echo ""

        # Sjekk om claude er tilgjengelig
        if command -v claude &> /dev/null; then
            cd "$SCRIPT_DIR"

            PROMPT="Du skal bygge en komplett salgsliste for Ruters samkj칮ringspilot. Les $ENRICHED_FILE.

VIKTIG: Du skal IKKE gi deg f칮r du har funnet kontaktperson for HVER bedrift. Tomme felter er IKKE akseptabelt med mindre du har utt칮mt ALLE kilder.

METODIKK FOR HVER BEDRIFT (f칮lg denne rekkef칮lgen):

1. HJEMMESIDE (hvis tilgjengelig):
   - G친 til /kontakt, /om-oss, /about, /contact, /ledelse, /ansatte
   - Let etter: HR-sjef, Personalsjef, B칝rekraftsansvarlig, Daglig leder, CEO, Administrerende direkt칮r
   - Noter milj칮sertifiseringer (Milj칮fyrt친rn, ISO 14001, Svanemerket)

2. PROFF.NO (ALLTID sjekk denne):
   - Bruk proff_url fra filen, eller s칮k p친 bedriftsnavn
   - Under 'Roller' finner du styreleder, daglig leder, og andre n칮kkelpersoner med navn
   - Dette er ofte den beste kilden for kontaktpersoner

3. LINKEDIN (hvis fortsatt mangler):
   - S칮k: '[Bedriftsnavn] HR' eller '[Bedriftsnavn] daglig leder'
   - Finn relevante personer med navn og rolle

4. WEBS칒K (siste utvei):
   - S칮k: '[Bedriftsnavn] kontakt daglig leder' eller '[Bedriftsnavn] HR ansvarlig'

PRIORITERT REKKEF칒LGE FOR KONTAKTPERSON:
- HR-direkt칮r, HR-sjef, People & Culture-leder
- B칝rekraftsansvarlig, ESG-ansvarlig, Milj칮ansvarlig
- Kontorsjef, Facility Manager, Administrasjonssjef
- Daglig leder / CEO (spesielt for bedrifter < 50 ansatte)
- Styreleder (hvis ingen andre finnes)

SALGSARGUMENTER - finn spesifikke argumenter for hver bedrift:
- Milj칮sertifiseringer de har
- Vekst/ekspansjon som skaper behov
- Bransje som passer (transport, logistikk, bygg med mange p친 samme prosjekter)
- Lokasjon i industriomr친de med flere bedrifter

OUTPUT: Lagre til $FINAL_CSV med ALLE disse kolonnene:
organisasjonsnummer,navn,antallAnsatte,adresse,latitude,longitude,naeringskode_beskrivelse,hjemmeside,kontakt_navn,kontakt_rolle,kontakt_telefon,kontakt_epost,salgsnotater,proff_url

KRAV TIL KVALITET:
- kontakt_navn: SKAL ha verdi (minst daglig leder fra Proff.no)
- kontakt_rolle: SKAL ha verdi
- salgsnotater: SKAL ha minst 2-3 spesifikke argumenter per bedrift
- Kun UNNTAKSVIS skal felter v칝re tomme, og da kun etter at alle kilder er sjekket

Start med 친 lese $ENRICHED_FILE, deretter jobb systematisk gjennom hver bedrift."

            # Start claude interaktivt med prompten
            echo "$PROMPT" | claude --allowedTools "WebSearch,WebFetch,Read,Write,Task"

            # Check if Claude created the final CSV
            if [ -f "$FINAL_CSV" ]; then
                # Clean up intermediate files
                rm -f "$FILTERED_FILE" "$ENRICHED_FILE" "$CONTACTS_FILE"

                # Generate HTML report
                echo ""
                echo "============================================================"
                echo "  Steg 4: Genererer HTML-rapport..."
                echo "============================================================"
                python -c "
import pandas as pd
from pathlib import Path
import sys
sys.path.insert(0, '$SCRIPT_DIR')
from enrich_companies import generate_html_report

df = pd.read_csv('$FINAL_CSV', dtype=str)
html_path = generate_html_report(df, Path('$FINAL_CSV'), '$AREA_NAME'.replace('_', ' ').title())
print(f'HTML-rapport: {html_path}')
"
                # Rename HTML to rapport.html
                mv "${FINAL_CSV%.csv}.html" "$FINAL_HTML" 2>/dev/null || true

                # Sync to Google Sheets if configured
                if [ -f "$SCRIPT_DIR/sheets_config.json" ]; then
                    echo ""
                    echo "============================================================"
                    echo "  Steg 5: Synkroniserer til Google Sheets..."
                    echo "============================================================"
                    python "$SCRIPT_DIR/google_sheets.py" sync "$FINAL_CSV"
                fi

                echo ""
                echo "============================================================"
                echo "  Ferdig! Resultater i: $AREA_FOLDER"
                echo ""
                echo "  游늯 $FINAL_CSV"
                echo "  游늵 $FINAL_HTML"
                echo "============================================================"

                # Open HTML report
                open "$FINAL_HTML" 2>/dev/null || xdg-open "$FINAL_HTML" 2>/dev/null || echo "칀pne rapporten manuelt: $FINAL_HTML"
            else
                echo ""
                echo "Advarsel: Ferdig CSV ble ikke opprettet av Claude."
                echo "Mellomfiler beholdt for feils칮king i: $AREA_FOLDER"
            fi
        else
            echo "Claude CLI ikke funnet. Installer det eller kj칮r manuelt:"
            echo "  claude 'Finn kontaktpersoner for $ENRICHED_FILE'"
            echo ""
            echo "Mellomfiler i: $AREA_FOLDER"
        fi
    else
        echo "Feil: Kunne ikke finne output-filen: $FILTERED_FILE"
        exit 1
    fi
fi
